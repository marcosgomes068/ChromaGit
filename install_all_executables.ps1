# ChromaGit - Instalador Completo de ExecutÃ¡veis
# Execute como Administrador: PowerShell -ExecutionPolicy Bypass -File install_all_executables.ps1

param(
    [switch]$User,
    [switch]$System,
    [switch]$Remove
)

# Cores para output
$Colors = @{
    Red = "Red"
    Green = "Green"
    Yellow = "Yellow"
    Blue = "Blue"
    Cyan = "Cyan"
    Magenta = "Magenta"
}

function Write-ColorOutput {
    param([string]$Message, [string]$Color = "White")
    Write-Host $Message -ForegroundColor $Color
}

function Test-Administrator {
    $currentUser = [Security.Principal.WindowsIdentity]::GetCurrent()
    $principal = New-Object Security.Principal.WindowsPrincipal($currentUser)
    return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
}

function Get-ChromaGitExecutables {
    param([string]$ChromaGitPath)
    
    $executables = @()
    $exeFiles = Get-ChildItem -Path $ChromaGitPath -Filter "*.exe" | Where-Object { $_.Name -ne "ChromaGit-Desktop.exe" }
    
    foreach ($exe in $exeFiles) {
        $baseName = [System.IO.Path]::GetFileNameWithoutExtension($exe.Name)
        $executables += @{
            Name = $baseName
            Path = $exe.FullName
            FileName = $exe.Name
        }
    }
    
    return $executables
}

function Create-AllLaunchers {
    param([string]$ChromaGitPath)
    
    Write-ColorOutput "ğŸ“ Criando scripts de lanÃ§amento para todos os executÃ¡veis..." $Colors.Blue
    
    $executables = Get-ChromaGitExecutables $ChromaGitPath
    $createdFiles = @()
    
    foreach ($exe in $executables) {
        $batchContent = "@echo off`r`n"
        $batchContent += "REM $($exe.Name) Launcher`r`n"
        $batchContent += "REM Auto-generated by install_all_executables.ps1`r`n`r`n"
        $batchContent += "if exist `"$($exe.Path)`" (`r`n"
        $batchContent += "    `"$($exe.Path)`" %*`r`n"
        $batchContent += ") else (`r`n"
        $batchContent += "    echo Erro: $($exe.FileName) nao encontrado`r`n"
        $batchContent += "    exit /b 1`r`n"
        $batchContent += ")`r`n"
        
        try {
            $batchPath = Join-Path $ChromaGitPath "$($exe.Name).bat"
            $batchContent | Out-File -FilePath $batchPath -Encoding ASCII -Force
            $createdFiles += $batchPath
            Write-ColorOutput "  âœ… $($exe.Name).bat criado" $Colors.Green
        }
        catch {
            Write-ColorOutput "  âŒ Erro ao criar $($exe.Name).bat: $($_.Exception.Message)" $Colors.Red
        }
    }
    
    # Criar launcher principal chromagit
    $mainBatchContent = "@echo off`r`n"
    $mainBatchContent += "REM ChromaGit Main Launcher`r`n"
    $mainBatchContent += "REM Auto-generated by install_all_executables.ps1`r`n`r`n"
    $mainBatchContent += "if exist `"$ChromaGitPath\ChromaGit.exe`" (`r`n"
    $mainBatchContent += "    `"$ChromaGitPath\ChromaGit.exe`" %*`r`n"
    $mainBatchContent += ") else (`r`n"
    $mainBatchContent += "    echo Erro: ChromaGit.exe nao encontrado`r`n"
    $mainBatchContent += "    exit /b 1`r`n"
    $mainBatchContent += ")`r`n"
    
    try {
        $mainBatchPath = Join-Path $ChromaGitPath "chromagit.bat"
        $mainBatchContent | Out-File -FilePath $mainBatchPath -Encoding ASCII -Force
        $createdFiles += $mainBatchPath
        Write-ColorOutput "  âœ… chromagit.bat criado" $Colors.Green
    }
    catch {
        Write-ColorOutput "  âŒ Erro ao criar chromagit.bat: $($_.Exception.Message)" $Colors.Red
    }
    
    return $createdFiles
}

function Add-ToUserPath {
    param([string]$ChromaGitPath)
    
    Write-ColorOutput "ğŸ”§ Adicionando ChromaGit ao PATH do usuÃ¡rio..." $Colors.Blue
    
    $userPath = [Environment]::GetEnvironmentVariable("PATH", "User")
    
    if ($userPath -like "*$ChromaGitPath*") {
        Write-ColorOutput "âœ… ChromaGit jÃ¡ estÃ¡ no PATH do usuÃ¡rio" $Colors.Green
        return $true
    }
    
    try {
        $newPath = "$ChromaGitPath;$userPath"
        [Environment]::SetEnvironmentVariable("PATH", $newPath, "User")
        Write-ColorOutput "âœ… ChromaGit adicionado ao PATH do usuÃ¡rio com sucesso!" $Colors.Green
        return $true
    }
    catch {
        Write-ColorOutput "âŒ Erro ao adicionar ao PATH do usuÃ¡rio: $($_.Exception.Message)" $Colors.Red
        return $false
    }
}

function Add-ToSystemPath {
    param([string]$ChromaGitPath)
    
    if (-not (Test-Administrator)) {
        Write-ColorOutput "âŒ PrivilÃ©gios de administrador necessÃ¡rios para PATH do sistema" $Colors.Red
        Write-ColorOutput "ğŸ’¡ Execute como administrador ou use -User para PATH do usuÃ¡rio" $Colors.Yellow
        return $false
    }
    
    Write-ColorOutput "ğŸ”§ Adicionando ChromaGit ao PATH do sistema..." $Colors.Blue
    
    $systemPath = [Environment]::GetEnvironmentVariable("PATH", "Machine")
    
    if ($systemPath -like "*$ChromaGitPath*") {
        Write-ColorOutput "âœ… ChromaGit jÃ¡ estÃ¡ no PATH do sistema" $Colors.Green
        return $true
    }
    
    try {
        $newPath = "$ChromaGitPath;$systemPath"
        [Environment]::SetEnvironmentVariable("PATH", $newPath, "Machine")
        Write-ColorOutput "âœ… ChromaGit adicionado ao PATH do sistema com sucesso!" $Colors.Green
        return $true
    }
    catch {
        Write-ColorOutput "âŒ Erro ao adicionar ao PATH do sistema: $($_.Exception.Message)" $Colors.Red
        return $false
    }
}

function Remove-FromPath {
    param([string]$ChromaGitPath)
    
    Write-ColorOutput "ğŸ—‘ï¸ Removendo ChromaGit do PATH..." $Colors.Yellow
    
    # Remover do PATH do usuÃ¡rio
    $userPath = [Environment]::GetEnvironmentVariable("PATH", "User")
    if ($userPath -like "*$ChromaGitPath*") {
        $newUserPath = $userPath -replace [regex]::Escape("$ChromaGitPath;"), ""
        $newUserPath = $newUserPath -replace [regex]::Escape(";$ChromaGitPath"), ""
        $newUserPath = $newUserPath -replace [regex]::Escape($ChromaGitPath), ""
        [Environment]::SetEnvironmentVariable("PATH", $newUserPath, "User")
        Write-ColorOutput "âœ… Removido do PATH do usuÃ¡rio" $Colors.Green
    }
    
    # Remover do PATH do sistema (se for administrador)
    if (Test-Administrator) {
        $systemPath = [Environment]::GetEnvironmentVariable("PATH", "Machine")
        if ($systemPath -like "*$ChromaGitPath*") {
            $newSystemPath = $systemPath -replace [regex]::Escape("$ChromaGitPath;"), ""
            $newSystemPath = $newSystemPath -replace [regex]::Escape(";$ChromaGitPath"), ""
            $newSystemPath = $newSystemPath -replace [regex]::Escape($ChromaGitPath), ""
            [Environment]::SetEnvironmentVariable("PATH", $newSystemPath, "Machine")
            Write-ColorOutput "âœ… Removido do PATH do sistema" $Colors.Green
        }
    }
    
    # Remover arquivos .bat criados
    $batFiles = Get-ChildItem -Path $ChromaGitPath -Filter "*.bat" | Where-Object { 
        $_.Name -match "(chromagit|add|commit|help|init|log|push)\.bat$" 
    }
    
    foreach ($batFile in $batFiles) {
        try {
            Remove-Item $batFile.FullName -Force
            Write-ColorOutput "âœ… Removido: $($batFile.Name)" $Colors.Green
        }
        catch {
            Write-ColorOutput "âŒ Erro ao remover $($batFile.Name): $($_.Exception.Message)" $Colors.Red
        }
    }
}

function Show-AvailableCommands {
    param([string]$ChromaGitPath)
    
    Write-ColorOutput "ğŸ“‹ Comandos disponÃ­veis apÃ³s instalaÃ§Ã£o:" $Colors.Blue
    Write-Host ""
    
    $executables = Get-ChromaGitExecutables $ChromaGitPath
    
    # Comando principal
    Write-ColorOutput "ğŸš€ Comando Principal:" $Colors.Cyan
    Write-ColorOutput "  chromagit                # Interface principal do ChromaGit" $Colors.White
    Write-ColorOutput "  chromagit --version      # Exibir versÃ£o" $Colors.White
    Write-ColorOutput "  chromagit --help         # Ajuda completa" $Colors.White
    Write-Host ""
    
    # Comandos individuais
    Write-ColorOutput "âš¡ Comandos Diretos:" $Colors.Cyan
    foreach ($exe in $executables) {
        switch ($exe.Name) {
            "init" { 
                Write-ColorOutput "  init                     # Inicializar repositÃ³rio" $Colors.White 
            }
            "add" { 
                Write-ColorOutput "  add                      # Adicionar arquivos" $Colors.White 
            }
            "commit" { 
                Write-ColorOutput "  commit                   # Fazer commit" $Colors.White 
            }
            "log" { 
                Write-ColorOutput "  log                      # Ver histÃ³rico" $Colors.White 
            }
            "push" { 
                Write-ColorOutput "  push                     # Sincronizar" $Colors.White 
            }
            "help" { 
                Write-ColorOutput "  help                     # Ajuda detalhada" $Colors.White 
            }
        }
    }
    
    Write-Host ""
    Write-ColorOutput "ğŸ’¡ Exemplos de uso:" $Colors.Yellow
    Write-ColorOutput "  chromagit init           # Iniciar novo repositÃ³rio" $Colors.White
    Write-ColorOutput "  add .                    # Adicionar todos os arquivos" $Colors.White
    Write-ColorOutput "  commit -m 'Mensagem'     # Commit direto" $Colors.White
    Write-ColorOutput "  log --limit 10           # Ver Ãºltimos 10 commits" $Colors.White
    Write-ColorOutput "  push -b main             # Sincronizar branch main" $Colors.White
}

function Test-Installation {
    param([string]$ChromaGitPath)
    
    Write-ColorOutput "ğŸ” Testando instalaÃ§Ã£o..." $Colors.Blue
    Write-Host ""
    
    $allWorking = $true
    
    # Testar comando principal
    $chromaGitBat = Join-Path $ChromaGitPath "chromagit.bat"
    if (Test-Path $chromaGitBat) {
        try {
            $result = & $chromaGitBat "--version" 2>&1
            if ($LASTEXITCODE -eq 0) {
                Write-ColorOutput "âœ… chromagit funcionando: $result" $Colors.Green
            } else {
                Write-ColorOutput "âŒ chromagit falhou" $Colors.Red
                $allWorking = $false
            }
        }
        catch {
            Write-ColorOutput "âŒ Erro ao testar chromagit: $($_.Exception.Message)" $Colors.Red
            $allWorking = $false
        }
    } else {
        Write-ColorOutput "âŒ chromagit.bat nÃ£o encontrado" $Colors.Red
        $allWorking = $false
    }
    
    # Testar comandos individuais
    $executables = Get-ChromaGitExecutables $ChromaGitPath
    $workingCommands = 0
    
    foreach ($exe in $executables) {
        $batFile = Join-Path $ChromaGitPath "$($exe.Name).bat"
        if (Test-Path $batFile) {
            $workingCommands++
            Write-ColorOutput "âœ… $($exe.Name) disponÃ­vel" $Colors.Green
        } else {
            Write-ColorOutput "âŒ $($exe.Name) nÃ£o disponÃ­vel" $Colors.Red
            $allWorking = $false
        }
    }
    
    Write-Host ""
    if ($allWorking) {
        Write-ColorOutput "ğŸ‰ InstalaÃ§Ã£o completa! $($workingCommands + 1) comandos disponÃ­veis" $Colors.Green
    } else {
        Write-ColorOutput "âš ï¸ InstalaÃ§Ã£o parcial. Alguns comandos podem nÃ£o funcionar" $Colors.Yellow
    }
    
    return $allWorking
}

function Main {
    Write-ColorOutput "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®" $Colors.Cyan
    Write-ColorOutput "â”‚    ChromaGit - Instalador de ExecutÃ¡veis    â”‚" $Colors.Cyan
    Write-ColorOutput "â”‚      Adicionar TODOS os comandos ao PATH    â”‚" $Colors.Cyan
    Write-ColorOutput "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯" $Colors.Cyan
    Write-Host ""
    
    # Determinar diretÃ³rio do ChromaGit
    $scriptDir = Split-Path -Parent $MyInvocation.MyCommand.Path
    $chromaGitDir = Join-Path $scriptDir "obj"
    
    if (-not (Test-Path $chromaGitDir)) {
        Write-ColorOutput "âŒ DiretÃ³rio obj/ nÃ£o encontrado em: $chromaGitDir" $Colors.Red
        Write-ColorOutput "ğŸ’¡ Execute este script na pasta raiz do ChromaGit" $Colors.Yellow
        exit 1
    }
    
    Write-ColorOutput "ğŸ“ ChromaGit encontrado em: $chromaGitDir" $Colors.Green
    
    # Listar executÃ¡veis disponÃ­veis
    $executables = Get-ChromaGitExecutables $chromaGitDir
    Write-ColorOutput "ğŸ” ExecutÃ¡veis encontrados: $($executables.Count)" $Colors.Blue
    foreach ($exe in $executables) {
        Write-ColorOutput "  ğŸ“¦ $($exe.FileName)" $Colors.White
    }
    Write-Host ""
    
    # AÃ§Ãµes baseadas nos parÃ¢metros
    if ($Remove) {
        Remove-FromPath $chromaGitDir
    }
    elseif ($System) {
        $launchers = Create-AllLaunchers $chromaGitDir
        $success = Add-ToSystemPath $chromaGitDir
        if ($success) {
            Write-ColorOutput "âœ… $($launchers.Count) launchers criados" $Colors.Green
        }
    }
    elseif ($User) {
        $launchers = Create-AllLaunchers $chromaGitDir
        $success = Add-ToUserPath $chromaGitDir
        if ($success) {
            Write-ColorOutput "âœ… $($launchers.Count) launchers criados" $Colors.Green
        }
    }
    else {
        # Perguntar ao usuÃ¡rio
        Write-ColorOutput "Escolha uma opÃ§Ã£o:" $Colors.Blue
        Write-ColorOutput "1. Instalar TODOS os executÃ¡veis no PATH do usuÃ¡rio (recomendado)" $Colors.White
        Write-ColorOutput "2. Instalar TODOS os executÃ¡veis no PATH do sistema (requer admin)" $Colors.White
        Write-ColorOutput "3. Remover todos os executÃ¡veis do PATH" $Colors.White
        Write-ColorOutput "4. Testar instalaÃ§Ã£o existente" $Colors.White
        Write-ColorOutput "5. Cancelar" $Colors.White
        Write-Host ""
        
        $choice = Read-Host "Digite sua escolha (1-5)"
        
        switch ($choice) {
            "1" {
                $launchers = Create-AllLaunchers $chromaGitDir
                $success = Add-ToUserPath $chromaGitDir
                if ($success) {
                    Write-ColorOutput "âœ… $($launchers.Count) launchers criados" $Colors.Green
                }
            }
            "2" {
                $launchers = Create-AllLaunchers $chromaGitDir
                $success = Add-ToSystemPath $chromaGitDir
                if ($success) {
                    Write-ColorOutput "âœ… $($launchers.Count) launchers criados" $Colors.Green
                }
            }
            "3" {
                Remove-FromPath $chromaGitDir
            }
            "4" {
                Test-Installation $chromaGitDir
                exit 0
            }
            "5" {
                Write-ColorOutput "OperaÃ§Ã£o cancelada" $Colors.Yellow
                exit 0
            }
            default {
                Write-ColorOutput "âŒ OpÃ§Ã£o invÃ¡lida" $Colors.Red
                exit 1
            }
        }
    }
    
    Write-Host ""
    Write-ColorOutput "ğŸ§ª Testando instalaÃ§Ã£o..." $Colors.Blue
    $testResult = Test-Installation $chromaGitDir
    
    Write-Host ""
    Write-ColorOutput "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®" $Colors.Green
    Write-ColorOutput "â”‚              InstalaÃ§Ã£o ConcluÃ­da!          â”‚" $Colors.Green
    Write-ColorOutput "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯" $Colors.Green
    Write-Host ""
    
    Show-AvailableCommands $chromaGitDir
    
    Write-Host ""
    Write-ColorOutput "âš ï¸ IMPORTANTE: Reinicie o terminal para usar os comandos globalmente!" $Colors.Yellow
    Write-ColorOutput "ğŸ“ Para usar agora, execute: `$env:PATH = '$chromaGitDir;' + `$env:PATH" $Colors.Cyan
}

# Executar funÃ§Ã£o principal
Main
